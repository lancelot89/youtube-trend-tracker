# Work Log 2025-08-09

## 目的
ローカル環境での `youtube-trend-tracker` の動作確認と、Docker Compose を使った `fetcher` サービスの起動設定。

## 実施内容

### 1. `curl` を使った動作確認の開始
- 最初に `curl` を実行しようとしたが、エンドポイントが不明だったため、プロジェクト構成の確認から開始。

### 2. `docker-compose.yml` の確認
- `bq-emulator` サービスが `9050` (HTTP) と `9060` (gRPC) ポートを公開していることを確認。

### 3. `cmd/fetcher/main.go` の確認
- `fetcher` サービスが HTTP サーバーとして動作し、デフォルトで `8080` ポートを使用することを確認。
- 必須環境変数 (`PROJECT_ID`, `YOUTUBE_API_KEY`, `CHANNEL_CONFIG_PATH`) を確認。

### 4. `configs/channels.yaml` の確認
- YouTube チャンネル ID の設定ファイルであることを確認。

### 5. `fetcher` サービスの起動と `curl` でのエラー (初回)
- `curl http://localhost:8080/` を実行したが、`Failed to setup BigQuery table` エラーが発生。

### 6. `docker ps` で `bq-emulator` の稼働確認
- `bq-emulator` コンテナが正常に稼働していることを確認。

### 7. `internal/storage/bq.go` の確認
- BigQuery エミュレータへの接続に `BIGQUERY_EMULATOR_HOST` 環境変数が使用されていることを確認。
- `EnsureTableExists` 関数でデータセットとテーブルが作成されることを確認。

### 8. `curl` で BigQuery エミュレータのテーブル存在確認
- `http://localhost:9050/projects/test-project/datasets/youtube/tables/video_trends/data` を実行し、`dataset youtube is not found` エラーを確認。データセットが存在しないことを確認。

### 9. `fetcher` サービスをローカルでビルド・実行
- `PROJECT_ID` を `test-project` に、`CHANNEL_CONFIG_PATH` を絶対パスに設定。
- `YOUTUBE_API_KEY` は `.env` から読み込まれることを確認。
- `start_fetcher.sh` スクリプトを作成し、環境変数を設定して `fetcher` をバックグラウンドで実行するように設定。

### 10. `fetcher` サービス実行時のエラーと修正 (1回目)
- `bigquery: field "views": type uint64 is not supported` エラーが発生。
- `internal/storage/bq.go` の `VideoStatsRecord` の `Views`, `Likes`, `Comments` を `uint64` から `int64` に修正。
- `internal/fetcher/fetcher.go` で `uint64` から `int64` への型キャストを追加。

### 11. `fetcher` サービス実行時のエラーと修正 (2回目)
- `listen tcp :8080: bind: Only one usage of each socket address` エラーが発生。
- 既存の `fetcher` プロセスが残っていたため、手動で停止を依頼。

### 12. `MERGE` ステートメントのエラーと修正
- `googleapi: Error 400: currently MERGE expression is supported equal expression only` エラーが発生。
- `MERGE` ステートメントが BigQuery エミュレータで完全にサポートされていない可能性を考慮し、`MERGE` を単純な `INSERT` に置き換えることを決定。
- `internal/storage/bq.go` の `InsertVideoStats` 関数を修正し、`bigquery.Inserter` を直接使用してデータを挿入するように変更。

### 13. Docker Compose を使った `fetcher` サービスの起動
- 毎回再ビルドする手間を省くため、Docker Compose を使って `fetcher` サービスを起動するように設定。
- `docker-compose.yml` に `fetcher` サービスを追加。
- `PROJECT_ID`, `CHANNEL_CONFIG_PATH`, `BIGQUERY_EMULATOR_HOST` を設定。
- `.env` ファイルがコンテナ内で読み込まれない問題が発生。`Dockerfile` の `WORKDIR` と `ENTRYPOINT` を確認し、`.env` を `/srv/.env` にボリュームマウントするように `docker-compose.yml` を修正。

### 14. 最終的な動作確認とデータ取得
- `docker-compose build --no-cache fetcher` でイメージを再ビルド。
- `docker-compose up -d fetcher` でサービスを起動。
- `curl http://localhost:8080/` を実行し、`{"status":"success"}` を確認。
- `docker-compose logs fetcher` でログを確認し、BigQuery エミュレータへのデータ挿入が成功していることを確認。
- `curl http://localhost:9050/projects/test-project/datasets/youtube/tables/video_trends/data` を実行し、BigQuery エミュレータからデータが取得できることを確認。

## 結論
ローカル環境での `youtube-trend-tracker` の動作確認が成功し、Docker Compose を使った `fetcher` サービスの起動設定も完了しました。BigQuery エミュレータへのデータ挿入も正しく行われるようになりました。

## コミット
`feat: Implement local development environment with Docker Compose`

---

## 2025-08-09: ドキュメント拡充とリファクタリング

### 1. `README.md` の更新
- **目的**: プロジェクトの理解と利用を容易にするため、不足していた情報を追記。
- **変更点**:- 「ローカル開発」セクションに `go test ./...` を追加。
- 「設定ファイル」(`configs/*.yaml`) の役割を説明するセクションを追加。
- 「データモデル (BigQuery)」セクションを追加し、テーブルスキーマを明記。

### 2. リファクタリングの実施
- **目的**: コードの品質と柔軟性を向上させる。
- **変更点**:- `Refactoring.md`: 進捗状況とタスクリストを詳細に更新。
- チャンネルごとに取得する動画の最大数を、環境変数 `MAX_VIDEOS_PER_CHANNEL` で設定できるように変更。
- 上記変更に伴い、関連するGoのソースコード (`cmd/fetcher/main.go`, `internal/fetcher/fetcher.go`, `internal/youtube/client.go`) を修正。

### 3. デプロイスクリプトの改善と README の更新
- **目的**: デプロイプロセスの信頼性と安全性を向上させ、ドキュメントを最新の状態に保つ。
- **変更点**:- `scripts/` 内のデプロイ関連スクリプトをレビューし、以下の点を修正。
- `setup-artifact-registry.sh`: 冪等性を確保するため、リポジトリの存在チェックを追加。
- `build-and-push.sh`: 開発環境に依存しないよう、`--platform linux/amd64` を追加。
- `deploy-cloud-run.sh`: セキュリティ向上のため、`--no-allow-unauthenticated` に変更。
- `create-scheduler.sh`: 冪等性の確保と、IAM権限のスコープを限定するように修正。
- `README.md` を全面的に更新。
- `クイックスタート` セクションを、修正後のスクリプトに合わせたコマンド例に刷新。
- `詳細ステップ` セクションのコマンド例も、最新の内容に修正。

---

## 2025年8月9日 (土) Git Diff からの修正内容

- **README.md**:
    - `YOUTUBE_API_KEY` 環境変数の追加。
    - デプロイ手順のステップ数を更新し、YouTube APIキーをSecret Managerに登録するステップを追加。
    - `enable-apis.sh` の説明に、`bigquery.dataEditor` および `secretmanager.secretAccessor` ロールの付与に関する記述を追加。
- **configs/channels.yaml**:
    - 新しいYouTubeチャンネルID (`UCG_oqDSlIYEspNpd2H4zWhw` と `UC8yHePe_RgUBE-waRWy6olw`) を追加。
- **scripts/deploy-cloud-run.sh**:
    - Cloud Run サービスアカウントに `youtube-api-key` Secret へのアクセス権限 (`roles/secretmanager.secretAccessor`) を付与するコマンドを追加。

---

## 2025年8月9日 (土) Cloud Scheduler スクリプトの修正

- **scripts/create-scheduler.sh** の修正:
    - Cloud Scheduler ジョブの存在を確認し、存在しない場合は `create`、存在する場合は `update` を実行するように条件分岐を追加。
    - `gcloud scheduler jobs` コマンドで `--oauth-service-account-email` の代わりに `--oidc-service-account-email` を使用するように変更。

---

## 2025年8月9日 (土) 再デプロイスクリプトの修正とドキュメント更新

- **scripts/redeploy.sh** の修正:
    - Cloud Scheduler の更新は再デプロイ時に不要であるため、`scripts/create-scheduler.sh` の呼び出しを削除。
    - スクリプト内のステップ表示を `Step 1/2`, `Step 2/2` に変更。
- **README.md** の修正:
    - 「2回目以降のデプロイ」セクションの説明から「Cloud Scheduler ジョブの更新」に関する記述を削除し、より正確な説明に修正。

---

## 2025年8月9日 (土) Git Diff からの修正内容

- **cmd/fetcher/main.go**:
    - 環境変数 (`PROJECT_ID` または `GOOGLE_CLOUD_PROJECT`) からプロジェクトIDを取得する `getProjectID()` 関数を追加。
- **configs/channels.yaml**:
    - `Google Developers` チャンネルIDを削除。
- **deployments/cloudrun/service.yaml**:
    - Cloud Run サービスアカウント名、イメージタグ、環境変数を更新。
- **internal/fetcher/fetcher.go**:
    - `cloud.google.com/go/civil` をインポートし、`SnapshotDate` に `todayJST()` 関数を使用するように変更。`todayJST()` 関数を追加。
- **internal/storage/bq.go**:
    - `cloud.google.com/go/civil` をインポートし、`SnapshotDate` の型を `civil.Date` に変更。
- **scripts/deploy-cloud-run.sh**:
    - スクリプトの堅牢性を向上させ、イメージのタグ付け、APIの有効化、Artifact Registry の作成、Docker ビルドとプッシュ、サービスアカウントの権限設定、Cloud Run デプロイコマンドの更新、デプロイ後のURL表示を追加。
