# Work Log 2025-08-09

## 目的
ローカル環境での `youtube-trend-tracker` の動作確認と、Docker Compose を使った `fetcher` サービスの起動設定。

## 実施内容

### 1. `curl` を使った動作確認の開始
- 最初に `curl` を実行しようとしたが、エンドポイントが不明だったため、プロジェクト構成の確認から開始。

### 2. `docker-compose.yml` の確認
- `bq-emulator` サービスが `9050` (HTTP) と `9060` (gRPC) ポートを公開していることを確認。

### 3. `cmd/fetcher/main.go` の確認
- `fetcher` サービスが HTTP サーバーとして動作し、デフォルトで `8080` ポートを使用することを確認。
- 必須環境変数 (`PROJECT_ID`, `YOUTUBE_API_KEY`, `CHANNEL_CONFIG_PATH`) を確認。

### 4. `configs/channels.yaml` の確認
- YouTube チャンネル ID の設定ファイルであることを確認。

### 5. `fetcher` サービスの起動と `curl` でのエラー (初回)
- `curl http://localhost:8080/` を実行したが、`Failed to setup BigQuery table` エラーが発生。

### 6. `docker ps` で `bq-emulator` の稼働確認
- `bq-emulator` コンテナが正常に稼働していることを確認。

### 7. `internal/storage/bq.go` の確認
- BigQuery エミュレータへの接続に `BIGQUERY_EMULATOR_HOST` 環境変数が使用されていることを確認。
- `EnsureTableExists` 関数でデータセットとテーブルが作成されることを確認。

### 8. `curl` で BigQuery エミュレータのテーブル存在確認
- `http://localhost:9050/projects/test-project/datasets/youtube/tables/video_trends/data` を実行し、`dataset youtube is not found` エラーを確認。データセットが存在しないことを確認。

### 9. `fetcher` サービスをローカルでビルド・実行
- `PROJECT_ID` を `test-project` に、`CHANNEL_CONFIG_PATH` を絶対パスに設定。
- `YOUTUBE_API_KEY` は `.env` から読み込まれることを確認。
- `start_fetcher.sh` スクリプトを作成し、環境変数を設定して `fetcher` をバックグラウンドで実行するように設定。

### 10. `fetcher` サービス実行時のエラーと修正 (1回目)
- `bigquery: field "views": type uint64 is not supported` エラーが発生。
- `internal/storage/bq.go` の `VideoStatsRecord` の `Views`, `Likes`, `Comments` を `uint64` から `int64` に修正。
- `internal/fetcher/fetcher.go` で `uint64` から `int64` への型キャストを追加。

### 11. `fetcher` サービス実行時のエラーと修正 (2回目)
- `listen tcp :8080: bind: Only one usage of each socket address` エラーが発生。
- 既存の `fetcher` プロセスが残っていたため、手動で停止を依頼。

### 12. `MERGE` ステートメントのエラーと修正
- `googleapi: Error 400: currently MERGE expression is supported equal expression only` エラーが発生。
- `MERGE` ステートメントが BigQuery エミュレータで完全にサポートされていない可能性を考慮し、`MERGE` を単純な `INSERT` に置き換えることを決定。
- `internal/storage/bq.go` の `InsertVideoStats` 関数を修正し、`bigquery.Inserter` を直接使用してデータを挿入するように変更。

### 13. Docker Compose を使った `fetcher` サービスの起動
- 毎回再ビルドする手間を省くため、Docker Compose を使って `fetcher` サービスを起動するように設定。
- `docker-compose.yml` に `fetcher` サービスを追加。
- `PROJECT_ID`, `CHANNEL_CONFIG_PATH`, `BIGQUERY_EMULATOR_HOST` を設定。
- `.env` ファイルがコンテナ内で読み込まれない問題が発生。`Dockerfile` の `WORKDIR` と `ENTRYPOINT` を確認し、`.env` を `/srv/.env` にボリュームマウントするように `docker-compose.yml` を修正。

### 14. 最終的な動作確認とデータ取得
- `docker-compose build --no-cache fetcher` でイメージを再ビルド。
- `docker-compose up -d fetcher` でサービスを起動。
- `curl http://localhost:8080/` を実行し、`{"status":"success"}` を確認。
- `docker-compose logs fetcher` でログを確認し、BigQuery エミュレータへのデータ挿入が成功していることを確認。
- `curl http://localhost:9050/projects/test-project/datasets/youtube/tables/video_trends/data` を実行し、BigQuery エミュレータからデータが取得できることを確認。

## 結論
ローカル環境での `youtube-trend-tracker` の動作確認が成功し、Docker Compose を使った `fetcher` サービスの起動設定も完了しました。BigQuery エミュレータへのデータ挿入も正しく行われるようになりました。

## コミット
`feat: Implement local development environment with Docker Compose`
